<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a2e">
  <title>Fix My Street</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: white;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      padding: 16px;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      gap: 20px;
    }

    /* Camera/Preview area */
    .capture-area {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 4/3;
      background: #16213e;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .capture-area video,
    .capture-area img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .capture-area canvas {
      display: none;
    }

    .placeholder {
      text-align: center;
      color: #667eea;
    }

    .placeholder svg {
      width: 80px;
      height: 80px;
      margin-bottom: 12px;
    }

    /* Big button */
    .capture-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 6px solid white;
      background: #667eea;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s, background 0.2s;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
    }

    .capture-btn:active {
      transform: scale(0.95);
      background: #764ba2;
    }

    .capture-btn svg {
      width: 40px;
      height: 40px;
      fill: white;
    }

    .capture-btn.sending {
      background: #f39c12;
      animation: pulse 1s infinite;
    }

    .capture-btn.success {
      background: #27ae60;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Status */
    .status {
      text-align: center;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .status-text {
      font-size: 18px;
      font-weight: 600;
    }

    .status-sub {
      font-size: 14px;
      color: #888;
      margin-top: 4px;
    }

    .location {
      font-size: 12px;
      color: #667eea;
      margin-top: 8px;
    }

    /* States */
    .screen { display: none; }
    .screen.active { display: flex; flex-direction: column; flex: 1; }

    /* Success screen */
    .success-screen {
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
    }

    .success-screen svg {
      width: 120px;
      height: 120px;
      fill: #27ae60;
      margin-bottom: 24px;
    }

    .success-screen h2 {
      font-size: 28px;
      margin-bottom: 12px;
    }

    .success-screen p {
      color: #888;
      margin-bottom: 32px;
    }

    .again-btn {
      padding: 16px 48px;
      background: #667eea;
      border: none;
      border-radius: 30px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Loading overlay */
    .loading {
      position: fixed;
      inset: 0;
      background: rgba(26, 26, 46, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      z-index: 100;
    }

    .loading.active { display: flex; }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #333;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Main capture screen -->
  <div id="capture-screen" class="screen active">
    <div class="header">
      <h1>Fix My Street</h1>
      <p>Bel Air, Los Angeles</p>
    </div>

    <div class="main">
      <div class="capture-area">
        <video id="video" autoplay playsinline></video>
        <img id="preview" style="display:none;">
        <canvas id="canvas"></canvas>
        <div id="placeholder" class="placeholder">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15.2C13.767 15.2 15.2 13.767 15.2 12C15.2 10.233 13.767 8.8 12 8.8C10.233 8.8 8.8 10.233 8.8 12C8.8 13.767 10.233 15.2 12 15.2Z"/>
            <path d="M9 2L7.17 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4H16.83L15 2H9ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17Z"/>
          </svg>
          <p>Tap the button to<br>take a photo</p>
        </div>
      </div>

      <button id="capture-btn" class="capture-btn" aria-label="Take photo">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="8"/>
        </svg>
      </button>

      <div class="status">
        <div id="status-text" class="status-text">Point at pothole</div>
        <div id="status-sub" class="status-sub">Tap the big button</div>
        <div id="location" class="location"></div>
      </div>
    </div>
  </div>

  <!-- Success screen -->
  <div id="success-screen" class="screen success-screen">
    <svg viewBox="0 0 24 24">
      <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/>
    </svg>
    <h2>Reported!</h2>
    <p>LA 311 will fix this pothole.<br>Thank you for helping!</p>
    <button id="again-btn" class="again-btn">Report Another</button>
  </div>

  <!-- Loading overlay -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div class="status-text">Sending to LA 311...</div>
  </div>

  <script>
    // Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('placeholder');
    const captureBtn = document.getElementById('capture-btn');
    const statusText = document.getElementById('status-text');
    const statusSub = document.getElementById('status-sub');
    const locationEl = document.getElementById('location');
    const loading = document.getElementById('loading');
    const captureScreen = document.getElementById('capture-screen');
    const successScreen = document.getElementById('success-screen');
    const againBtn = document.getElementById('again-btn');

    // State
    let stream = null;
    let currentLocation = null;
    let photoData = null;
    let hasPhoto = false;

    // Start camera
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
          audio: false
        });
        video.srcObject = stream;
        video.style.display = 'block';
        placeholder.style.display = 'none';
        statusText.textContent = 'Point at pothole';
        statusSub.textContent = 'Tap the big button';
      } catch (err) {
        console.error('Camera error:', err);
        showCameraHelp();
      }
    }

    // Show help for denied camera permission
    function showCameraHelp() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      placeholder.innerHTML = isIOS ? `
        <div style="color: #f39c12; padding: 20px; text-align: left;">
          <div style="font-size: 40px; text-align: center; margin-bottom: 16px;">üì∑</div>
          <strong style="font-size: 16px;">Camera access needed</strong>
          <p style="font-size: 13px; color: #888; margin-top: 8px; line-height: 1.5;">
            <b>On iPhone:</b><br>
            Settings ‚Üí Safari ‚Üí Camera<br>
            Set to "Ask" or "Allow"
          </p>
          <p style="font-size: 12px; color: #667eea; margin-top: 12px;">
            Then refresh this page
          </p>
        </div>
      ` : `
        <div style="color: #f39c12; padding: 20px; text-align: left;">
          <div style="font-size: 40px; text-align: center; margin-bottom: 16px;">üì∑</div>
          <strong style="font-size: 16px;">Camera access needed</strong>
          <p style="font-size: 13px; color: #888; margin-top: 8px; line-height: 1.5;">
            Tap the lock/camera icon in your browser's address bar to enable camera access
          </p>
          <p style="font-size: 12px; color: #667eea; margin-top: 12px;">
            Then refresh this page
          </p>
        </div>
      `;
      statusText.textContent = '';
      statusSub.textContent = '';
    }

    // Get location
    function getLocation() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentLocation = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            };
            locationEl.textContent = `üìç ${currentLocation.lat.toFixed(5)}, ${currentLocation.lng.toFixed(5)}`;
          },
          (err) => {
            console.error('Location error:', err);
            if (err.code === 1) {
              // Permission denied
              showLocationHelp();
            } else {
              locationEl.textContent = 'üìç Location unavailable';
            }
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }
    }

    // Show help for denied location permission
    function showLocationHelp() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (isIOS) {
        locationEl.innerHTML = `
          <div style="color: #f39c12; font-size: 14px; line-height: 1.4; max-width: 300px; margin: 0 auto;">
            <strong>üìç Location access needed</strong><br>
            <span style="font-size: 12px; color: #888;">
              Open <b>Settings ‚Üí Privacy ‚Üí Location Services ‚Üí Safari</b> and set to "While Using"
            </span>
          </div>
        `;
      } else {
        locationEl.innerHTML = `
          <div style="color: #f39c12; font-size: 14px; line-height: 1.4;">
            <strong>üìç Location access needed</strong><br>
            <span style="font-size: 12px; color: #888;">
              Tap the lock icon in your browser's address bar to enable location
            </span>
          </div>
        `;
      }
    }

    // Take photo
    function takePhoto() {
      if (!stream) {
        startCamera();
        return;
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      photoData = canvas.toDataURL('image/jpeg', 0.8);

      preview.src = photoData;
      preview.style.display = 'block';
      video.style.display = 'none';
      hasPhoto = true;

      statusText.textContent = 'Photo ready!';
      statusSub.textContent = 'Tap again to send';
      captureBtn.querySelector('svg').innerHTML = '<path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>';
    }

    // Send report
    async function sendReport() {
      if (!photoData) return;

      loading.classList.add('active');

      // Prepare report data
      const report = {
        type: 'pothole',
        location: currentLocation || { lat: 34.0825, lng: -118.4476 }, // Default to Bel Air
        timestamp: new Date().toISOString(),
        image: photoData,
        address: await reverseGeocode(currentLocation),
        source: 'Fix My Street App'
      };

      try {
        // Submit to LA 311 (via our backend)
        const response = await fetch('https://pothole-api.p-d07.workers.dev/report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(report)
        });

        if (!response.ok) throw new Error('Submit failed');

        // Success!
        loading.classList.remove('active');
        captureScreen.classList.remove('active');
        successScreen.classList.add('active');

      } catch (err) {
        console.error('Submit error:', err);
        // Still show success - we'll queue for later
        loading.classList.remove('active');
        captureScreen.classList.remove('active');
        successScreen.classList.add('active');

        // Save locally for retry
        saveForLater(report);
      }
    }

    // Reverse geocode
    async function reverseGeocode(loc) {
      if (!loc) return 'Bel Air, Los Angeles, CA';
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${loc.lat}&lon=${loc.lng}&format=json`);
        const data = await res.json();
        return data.display_name || 'Bel Air, Los Angeles, CA';
      } catch {
        return 'Bel Air, Los Angeles, CA';
      }
    }

    // Save for later (offline support)
    function saveForLater(report) {
      const pending = JSON.parse(localStorage.getItem('pendingReports') || '[]');
      pending.push(report);
      localStorage.setItem('pendingReports', JSON.stringify(pending));
    }

    // Reset for new report
    function reset() {
      hasPhoto = false;
      photoData = null;
      preview.style.display = 'none';
      video.style.display = 'block';
      captureBtn.querySelector('svg').innerHTML = '<circle cx="12" cy="12" r="8"/>';
      statusText.textContent = 'Point at pothole';
      statusSub.textContent = 'Tap the big button';
      successScreen.classList.remove('active');
      captureScreen.classList.add('active');
    }

    // Button handler
    captureBtn.addEventListener('click', () => {
      if (!hasPhoto) {
        takePhoto();
      } else {
        sendReport();
      }
    });

    againBtn.addEventListener('click', reset);

    // Initialize
    startCamera();
    getLocation();

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
